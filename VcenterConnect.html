<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>class VcenterConnect - vgopher v0.1</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
  var index_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link"><a href="Object.html">Object</a>
  
</div>

    <div id="includes-section" class="nav-section">
  <h3>Included Modules</h3>

  <ul class="link-list">
  
  
    <li><a class="include" href="Logging.html">Logging</a>
  
  
  </ul>
</div>

    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-get_vcenter_data">::get_vcenter_data</a>
    
    <li ><a href="#method-c-new">::new</a>
    
    <li ><a href="#method-c-to_vcenter">::to_vcenter</a>
    
    <li ><a href="#method-i-build_tree">#build_tree</a>
    
    <li ><a href="#method-i-cluster_output">#cluster_output</a>
    
    <li ><a href="#method-i-datastore_output">#datastore_output</a>
    
    <li ><a href="#method-i-dvs_output">#dvs_output</a>
    
    <li ><a href="#method-i-get_vcenter_data">#get_vcenter_data</a>
    
    <li ><a href="#method-i-hostsystem_output">#hostsystem_output</a>
    
    <li ><a href="#method-i-output">#output</a>
    
    <li ><a href="#method-i-to_vcenter">#to_vcenter</a>
    
    <li ><a href="#method-i-virt_machine_output">#virt_machine_output</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-VcenterConnect">
  <h1 id="class-VcenterConnect" class="class">
    class VcenterConnect
  </h1>

  <section class="description">
    
<p>pull data from vcenter api, store data in redis</p>

  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-get_vcenter_data" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_vcenter_data</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="get_vcenter_data-source">
            <pre><span class="ruby-comment"># File lib/vc_collect.rb, line 70</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_vcenter_data</span>
  <span class="ruby-identifier">new</span>.<span class="ruby-identifier">get_vcenter_data</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/vc_collect.rb, line 12</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>
  <span class="ruby-ivar">@vms</span> = {}
  <span class="ruby-ivar">@dvs</span> = {}
  <span class="ruby-ivar">@dvpg</span> = {}
  <span class="ruby-comment">#network = {}</span>
  <span class="ruby-ivar">@hosts</span> = {}
  <span class="ruby-ivar">@clusters</span> = {}
  <span class="ruby-ivar">@datastores</span> = {}
  <span class="ruby-ivar">@datacenter</span> = {}
  <span class="ruby-ivar">@folders</span> = {}
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-to_vcenter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">to_vcenter</span><span
            class="method-args">(vdc,vc,vc_user,vc_password)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="to_vcenter-source">
            <pre><span class="ruby-comment"># File lib/vc_collect.rb, line 24</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_vcenter</span>(<span class="ruby-identifier">vdc</span>,<span class="ruby-identifier">vc</span>,<span class="ruby-identifier">vc_user</span>,<span class="ruby-identifier">vc_password</span>)
  <span class="ruby-identifier">new</span>.<span class="ruby-identifier">to_vcenter</span>(<span class="ruby-identifier">vdc</span>,<span class="ruby-identifier">vc</span>,<span class="ruby-identifier">vc_user</span>,<span class="ruby-identifier">vc_password</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-build_tree" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">build_tree</span><span
            class="method-args">(dvpg, dvs, datastores, clusters, hosts, vms, vcenter_name)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>populate the redis store with vcenter api data</p>
          
          

          
          <div class="method-source-code" id="build_tree-source">
            <pre><span class="ruby-comment"># File lib/vc_collect.rb, line 475</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">build_tree</span>(<span class="ruby-identifier">dvpg</span>, <span class="ruby-identifier">dvs</span>, <span class="ruby-identifier">datastores</span>, <span class="ruby-identifier">clusters</span>, <span class="ruby-identifier">hosts</span>, <span class="ruby-identifier">vms</span>, <span class="ruby-identifier">vcenter_name</span>)
  <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-string">&quot;filling dvs values&quot;</span>
  <span class="ruby-identifier">dvs</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">vss</span><span class="ruby-operator">|</span>
    <span class="ruby-comment">#portgroups = vss[&#39;summary&#39;][:portgroupName].map {|name| name.downcase}</span>
    <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">dvs1</span> = <span class="ruby-constant">Vnetwork</span>.<span class="ruby-identifier">create</span>(
      <span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vss</span>[<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">downcase</span>,
      <span class="ruby-value">:uuid</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vss</span>[<span class="ruby-string">&#39;uuid&#39;</span>],
      <span class="ruby-value">:portgroups</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vss</span>[<span class="ruby-string">&#39;summary&#39;</span>][<span class="ruby-value">:portgroupName</span>],
      <span class="ruby-value">:vcenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vcenter_name</span>,
      <span class="ruby-value">:vdatacenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vdc1</span>
      )
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Ohm</span><span class="ruby-operator">::</span><span class="ruby-constant">UniqueIndexViolation</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">fault</span>
      <span class="ruby-identifier">dvs1_id</span> = <span class="ruby-constant">Vnetwork</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">uuid</span><span class="ruby-operator">:</span> <span class="ruby-identifier">vss</span>[<span class="ruby-string">&#39;uuid&#39;</span>]).<span class="ruby-identifier">to_a</span>[<span class="ruby-value">0</span>]
      <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;#{fault} - #{vss[&#39;name&#39;].downcase} already exists with id: #{dvs1_id.id}&quot;</span>
      <span class="ruby-keyword">next</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-string">&quot;filling datastore values&quot;</span>
  <span class="ruby-identifier">datastores</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">status</span> = <span class="ruby-node">&quot;accessible = #{ds[&#39;summary.accessible&#39;]}&quot;</span>
    <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">ds1</span> = <span class="ruby-constant">Vdatastore</span>.<span class="ruby-identifier">create</span>(
      <span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ds</span>[<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">downcase</span>,
      <span class="ruby-value">:capacity</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ds</span>[<span class="ruby-string">&#39;summary.capacity&#39;</span>],
      <span class="ruby-value">:free</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ds</span>[<span class="ruby-string">&#39;summary.freeSpace&#39;</span>],
      <span class="ruby-value">:used</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-identifier">ds</span>[<span class="ruby-string">&#39;summary.capacity&#39;</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">ds</span>[<span class="ruby-string">&#39;summary.freeSpace&#39;</span>]),
      <span class="ruby-comment">#:pct_used =&gt; (ds[&#39;summary.capacity&#39;].to_i - ds[&#39;summary.freeSpace&#39;].to_i) * 100 / ds[&#39;summary.capacity&#39;].to_i,</span>
      <span class="ruby-value">:url</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ds</span>[<span class="ruby-string">&#39;summary.url&#39;</span>],
      <span class="ruby-value">:accessible</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ds</span>[<span class="ruby-string">&#39;summary.accessible&#39;</span>],
      <span class="ruby-value">:vcenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vcenter_name</span>,
      <span class="ruby-value">:vdatacenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vdc1</span>
      )
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Ohm</span><span class="ruby-operator">::</span><span class="ruby-constant">UniqueIndexViolation</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">fault</span>
      <span class="ruby-identifier">ds1_id</span> = <span class="ruby-constant">Vdatastore</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">ds</span>[<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">downcase</span>).<span class="ruby-identifier">to_a</span>[<span class="ruby-value">0</span>]
      <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;#{fault} - #{ds[&#39;name&#39;].downcase} already exists with id: #{ds1_id.id}&quot;</span>
      <span class="ruby-keyword">next</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-string">&quot;filling cluster values&quot;</span>
  <span class="ruby-identifier">clusters</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cluster</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">c1</span> = <span class="ruby-constant">Cluster</span>.<span class="ruby-identifier">create</span>(
      <span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cluster</span>[<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">downcase</span>,
      <span class="ruby-value">:overallstatus</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cluster</span>[<span class="ruby-string">&#39;overallStatus&#39;</span>],
      <span class="ruby-value">:effectivecpu</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cluster</span>[<span class="ruby-string">&#39;summary.effectiveCpu&#39;</span>],
      <span class="ruby-value">:effectivememory</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cluster</span>[<span class="ruby-string">&#39;summary.effectiveMemory&#39;</span>],
      <span class="ruby-value">:numeffectivehosts</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cluster</span>[<span class="ruby-string">&#39;summary.numEffectiveHosts&#39;</span>],
      <span class="ruby-value">:numhosts</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cluster</span>[<span class="ruby-string">&#39;summary.numHosts&#39;</span>],
      <span class="ruby-value">:totalcpu</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cluster</span>[<span class="ruby-string">&#39;summary.totalCpu&#39;</span>],
      <span class="ruby-value">:totalmemory</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cluster</span>[<span class="ruby-string">&#39;summary.totalMemory&#39;</span>],
      <span class="ruby-value">:vcenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vcenter_name</span>,
      <span class="ruby-value">:vdatacenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vdc1</span>
      )
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Ohm</span><span class="ruby-operator">::</span><span class="ruby-constant">UniqueIndexViolation</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">fault</span>
      <span class="ruby-identifier">c1_id</span> = <span class="ruby-constant">Cluster</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">cluster</span>[<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">downcase</span>).<span class="ruby-identifier">to_a</span>[<span class="ruby-value">0</span>]
      <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;#{fault} - #{cluster[&#39;name&#39;].downcase} already exists with id: #{c1_id.id}&quot;</span>
      <span class="ruby-keyword">next</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-string">&quot;filling host values&quot;</span>
  <span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cnode</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># get the cluster object associated with this host</span>
    <span class="ruby-comment">#cluster_name = clusters.values_at(cnode[&#39;parent&#39;])[0][&#39;name&#39;]</span>
    <span class="ruby-identifier">clusta</span> = <span class="ruby-constant">Cluster</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">clusters</span>.<span class="ruby-identifier">values_at</span>(<span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;parent&#39;</span>])[<span class="ruby-value">0</span>][<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">downcase</span>).<span class="ruby-identifier">to_a</span>[<span class="ruby-value">0</span>]

    <span class="ruby-comment"># create a new hash with the key being sensorType and the value an array of sensor values</span>
    <span class="ruby-identifier">host_sensor_values</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">key</span>] = [] }
    <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;runtime.healthSystemRuntime&#39;</span>][<span class="ruby-value">:systemHealthInfo</span>][<span class="ruby-value">:numericSensorInfo</span>].<span class="ruby-identifier">collect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">host_sensor_values</span>[<span class="ruby-identifier">x</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_sym</span>] = <span class="ruby-identifier">x</span>.<span class="ruby-identifier">healthState</span>.<span class="ruby-identifier">props</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> {<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">to_sym</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span>} <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/dynamicProperty/</span> }.<span class="ruby-identifier">compact</span>
      <span class="ruby-identifier">host_sensor_values</span>[<span class="ruby-identifier">x</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_sym</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">x</span>.<span class="ruby-identifier">props</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> {<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">to_sym</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span>} <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/currentReading|baseUnits|sensorType/</span> }.<span class="ruby-identifier">compact</span>
    <span class="ruby-keyword">end</span>
    
    <span class="ruby-comment"># host services. get name, runlevel option, current status (:running is boolean)</span>
    <span class="ruby-identifier">host_services</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">key</span>] = [] }

    <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;config.service&#39;</span>][<span class="ruby-value">:service</span>].<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> 
      <span class="ruby-identifier">host_services</span>[<span class="ruby-identifier">x</span>.<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">x</span>.<span class="ruby-identifier">props</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> {<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">to_sym</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span>} <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/label|policy|running/</span> }.<span class="ruby-identifier">compact</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">host_filesystems</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">key</span>] = [] }

    <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;config.fileSystemVolume&#39;</span>][<span class="ruby-value">:mountInfo</span>].<span class="ruby-identifier">collect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">host_filesystems</span>[<span class="ruby-identifier">x</span>.<span class="ruby-identifier">mountInfo</span>.<span class="ruby-identifier">path</span>] = <span class="ruby-identifier">x</span>.<span class="ruby-identifier">mountInfo</span>.<span class="ruby-identifier">props</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> {<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">to_sym</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span>} <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/dynamicProperty/</span> }.<span class="ruby-identifier">compact</span>
      <span class="ruby-identifier">host_filesystems</span>[<span class="ruby-identifier">x</span>.<span class="ruby-identifier">mountInfo</span>.<span class="ruby-identifier">path</span>] = <span class="ruby-identifier">x</span>.<span class="ruby-identifier">volume</span>.<span class="ruby-identifier">props</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> {<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">to_sym</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span>} <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/dynamicProperty|extent/</span> }.<span class="ruby-identifier">compact</span>
    <span class="ruby-keyword">end</span>
    
    <span class="ruby-identifier">route_info</span> = {}
    <span class="ruby-identifier">route_info</span> = <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;config.network&#39;</span>][<span class="ruby-value">:dnsConfig</span>].<span class="ruby-identifier">props</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
      {<span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>] =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>]} <span class="ruby-keyword">if</span> <span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/domainName|address|searchDomain/</span>
    <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>

    <span class="ruby-identifier">biosinfo</span> = {}
    <span class="ruby-identifier">biosInfo</span> = <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;hardware.biosInfo&#39;</span>].<span class="ruby-identifier">props</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span>
      {<span class="ruby-identifier">b</span>[<span class="ruby-value">0</span>] =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">b</span>[<span class="ruby-value">1</span>]} <span class="ruby-keyword">unless</span> <span class="ruby-identifier">b</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/dynamicProperty/</span>
    <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>
    
    <span class="ruby-identifier">vnic_output</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">key</span>] = [] }
    <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;config.network&#39;</span>][<span class="ruby-value">:vnic</span>].<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">vnic</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">vnic_output</span>[<span class="ruby-identifier">vnic</span>.<span class="ruby-identifier">device</span>.<span class="ruby-identifier">to_sym</span>] = { 
        <span class="ruby-value">:portkey</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vnic</span>.<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">distributedVirtualPort</span>.<span class="ruby-identifier">portKey</span>, 
        <span class="ruby-value">:portgroupkey</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vnic</span>.<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">distributedVirtualPort</span>.<span class="ruby-identifier">portgroupKey</span>, 
        <span class="ruby-value">:switchuuid</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vnic</span>.<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">distributedVirtualPort</span>.<span class="ruby-identifier">switchUuid</span>, 
        <span class="ruby-value">:ipaddress</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vnic</span>.<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">ip</span>.<span class="ruby-identifier">ipAddress</span>, 
        <span class="ruby-value">:subnet</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vnic</span>.<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">ip</span>.<span class="ruby-identifier">subnetMask</span>, 
        <span class="ruby-value">:mtu</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vnic</span>.<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">mtu</span>
      }
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">fault</span>
      <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;#{fault} - #{cnode[&#39;name&#39;]} be havin a problem with vnics&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">h1_name</span> = <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">partition</span>(<span class="ruby-string">&#39;.&#39;</span>).<span class="ruby-identifier">shift</span>.<span class="ruby-identifier">downcase</span>
    <span class="ruby-identifier">h1_domain</span> = <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">partition</span>(<span class="ruby-string">&#39;.&#39;</span>).<span class="ruby-identifier">pop</span>.<span class="ruby-identifier">downcase</span>
    <span class="ruby-comment"># create new host entry in redis</span>
    <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">h1</span> = <span class="ruby-constant">Host</span>.<span class="ruby-identifier">create</span>(
      <span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">h1_name</span>,
      <span class="ruby-value">:domain</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">h1_domain</span>,
      <span class="ruby-value">:overallstatus</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;overallStatus&#39;</span>],
      <span class="ruby-value">:overallcpuusage</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;summary.quickStats.overallCpuUsage&#39;</span>],
      <span class="ruby-value">:overallmemoryusage</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;summary.quickStats.overallMemoryUsage&#39;</span>],
      <span class="ruby-value">:totalmemory</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;summary.hardware.memorySize&#39;</span>],
      <span class="ruby-value">:powerstate</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;runtime.powerState&#39;</span>],
      <span class="ruby-value">:connectionstate</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;runtime.connectionState&#39;</span>],
      <span class="ruby-value">:uptime</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;summary.quickStats.uptime&#39;</span>],
      <span class="ruby-value">:inmaintenancemode</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;summary.runtime.inMaintenanceMode&#39;</span>],
      <span class="ruby-value">:hardwaremodel</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;summary.hardware.model&#39;</span>],
      <span class="ruby-value">:vnics</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vnic_output</span>,
      <span class="ruby-value">:biosinfo</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">biosinfo</span>,
      <span class="ruby-value">:cluster</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">clusta</span>,
      <span class="ruby-value">:vcenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vcenter_name</span>,
      <span class="ruby-value">:vdatacenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vdc1</span>,
      <span class="ruby-value">:filesystems</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">host_filesystems</span>,
      <span class="ruby-value">:services</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">host_services</span>, 
      <span class="ruby-value">:sensors</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">host_sensor_values</span>,
      <span class="ruby-value">:route_info</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">route_info</span>
      )
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Ohm</span><span class="ruby-operator">::</span><span class="ruby-constant">UniqueIndexViolation</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">fault</span>
      <span class="ruby-identifier">h1_id</span> = <span class="ruby-constant">Host</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">h1_name</span>).<span class="ruby-identifier">to_a</span>[<span class="ruby-value">0</span>]
      <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;#{fault} - #{cnode[&#39;name&#39;].downcase} already exists with id: #{h1_id.id}&quot;</span>
      <span class="ruby-keyword">next</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># add attached vnetworks to the list within host object</span>
    <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;config.network&#39;</span>][<span class="ruby-value">:proxySwitch</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">network</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">dvs1</span> = <span class="ruby-constant">Vnetwork</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">network</span>.<span class="ruby-identifier">dvsName</span>.<span class="ruby-identifier">downcase</span>).<span class="ruby-identifier">to_a</span>[<span class="ruby-value">0</span>]
      <span class="ruby-identifier">h1</span>.<span class="ruby-identifier">vnetworks</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">dvs1</span>)
      <span class="ruby-identifier">network</span>[<span class="ruby-value">:spec</span>][<span class="ruby-value">:backing</span>][<span class="ruby-value">:pnicSpec</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">h1</span>.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">pnics</span><span class="ruby-operator">:</span> [ <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">pnicDevice</span>, <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">uplinkPortgroupKey</span> ])
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">dvs1</span>.<span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">h1</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># add attached datastores to the list within Host object</span>
    <span class="ruby-identifier">ds_names</span> = []
    <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;datastore&#39;</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">ds_names</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">datastores</span>.<span class="ruby-identifier">values_at</span>(<span class="ruby-identifier">ds</span>)[<span class="ruby-value">0</span>][<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">downcase</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">ds_names</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">_ds</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">vds1</span> = <span class="ruby-constant">Vdatastore</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">_ds</span>).<span class="ruby-identifier">to_a</span>[<span class="ruby-value">0</span>]
      <span class="ruby-identifier">h1</span>.<span class="ruby-identifier">vdatastores</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">vds1</span>)
      <span class="ruby-identifier">vds1</span>.<span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">h1</span>)
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-string">&quot;filling vms values&quot;</span>
  <span class="ruby-identifier">vms</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">vm</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">begin</span>
    <span class="ruby-comment"># if vm is a template, create a new object in redis, noting it is a template. then go to the next vm data object</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.config.template&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
      <span class="ruby-identifier">vm_tmpla</span> = <span class="ruby-constant">Vm</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">downcase</span>, <span class="ruby-identifier">vdatacenter</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@vdc1</span>, <span class="ruby-identifier">template</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;true&#39;</span>)
      <span class="ruby-keyword">next</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># get the host and cluster the vm belongs to</span>
    <span class="ruby-identifier">esx_host_fqdn</span> = <span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">values_at</span>(<span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.runtime.host&#39;</span>])[<span class="ruby-value">0</span>][<span class="ruby-string">&#39;name&#39;</span>]
    <span class="ruby-identifier">esx_host_name</span> = <span class="ruby-identifier">esx_host_fqdn</span>.<span class="ruby-identifier">partition</span>(<span class="ruby-string">&#39;.&#39;</span>)[<span class="ruby-value">0</span>].<span class="ruby-identifier">downcase</span>
    
    <span class="ruby-identifier">vmhost</span> = <span class="ruby-constant">Host</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">esx_host_name</span>).<span class="ruby-identifier">to_a</span>[<span class="ruby-value">0</span>]
    <span class="ruby-identifier">vmcluster</span> = <span class="ruby-constant">Cluster</span>[<span class="ruby-identifier">vmhost</span>.<span class="ruby-identifier">cluster_id</span>.<span class="ruby-identifier">to_i</span>]

    <span class="ruby-comment"># get the portgroup the vm is in. portgroup is an indexed attribute of a Vnetwork(vswitch) object bucket</span>
    <span class="ruby-identifier">portgroup</span> = <span class="ruby-identifier">dvpg</span>.<span class="ruby-identifier">values_at</span>(<span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;network&#39;</span>][<span class="ruby-value">0</span>])[<span class="ruby-value">0</span>][<span class="ruby-string">&#39;name&#39;</span>]
    <span class="ruby-identifier">vmnet</span> = <span class="ruby-constant">Vnetwork</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">portgroup</span><span class="ruby-operator">:</span> <span class="ruby-identifier">portgroup</span>).<span class="ruby-identifier">to_a</span>[<span class="ruby-value">0</span>]
    
    <span class="ruby-comment"># calculate the total provisioned storage for the vm</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.storage.uncommitted&#39;</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.storage.committed&#39;</span>].<span class="ruby-identifier">nil?</span>
      <span class="ruby-identifier">provisionedstorage</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.storage.uncommitted&#39;</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.storage.committed&#39;</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">exc</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">portgroup</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;#{exc} - #{vm[&#39;name&#39;].downcase} is not assigned to a portgroup&quot;</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;#{exc} - #{vm[&#39;name&#39;].downcase} is f-ed up. check it&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">guestdisk</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">key</span>] = [] }
    <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;guest.disk&#39;</span>].<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">disk</span><span class="ruby-operator">|</span> <span class="ruby-identifier">disk</span>.<span class="ruby-identifier">props</span>}.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">disk_props</span><span class="ruby-operator">|</span> <span class="ruby-identifier">guestdisk</span>[<span class="ruby-identifier">disk_props</span>[<span class="ruby-value">:diskPath</span>].<span class="ruby-identifier">to_sym</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">disk_props</span>[<span class="ruby-value">:freeSpace</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">disk_props</span>[<span class="ruby-value">:capacity</span>] }
    
    <span class="ruby-comment"># create a new vm entry in redis</span>
    <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">vm1</span> = <span class="ruby-constant">Vm</span>.<span class="ruby-identifier">create</span>(
      <span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">downcase</span>,
      <span class="ruby-value">:overallstatus</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.overallStatus&#39;</span>],
      <span class="ruby-value">:numcpu</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.config.numCpu&#39;</span>],
      <span class="ruby-value">:memoryallocated</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.config.memorySizeMB&#39;</span>],
      <span class="ruby-value">:hostmemoryusage</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.quickStats.hostMemoryUsage&#39;</span>],
      <span class="ruby-value">:guestmemoryusage</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.quickStats.guestMemoryUsage&#39;</span>],
      <span class="ruby-value">:balloonedmemory</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.quickStats.balloonedMemory&#39;</span>],
      <span class="ruby-value">:ipaddr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.guest.ipAddress&#39;</span>],
      <span class="ruby-value">:os</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.guest.guestFullName&#39;</span>],
      <span class="ruby-value">:vmwaretools_status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.guest.toolsRunningStatus&#39;</span>],
      <span class="ruby-value">:vmwaretools_version</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.guest.toolsVersionStatus2&#39;</span>],
      <span class="ruby-value">:powerstate</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.runtime.powerState&#39;</span>],
      <span class="ruby-value">:uptime</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.quickStats.uptimeSeconds&#39;</span>],
      <span class="ruby-value">:guestdisk</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">guestdisk</span>,
      <span class="ruby-value">:host</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vmhost</span>,
      <span class="ruby-value">:cluster</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vmcluster</span>,
      <span class="ruby-value">:locationid</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;config.locationId&#39;</span>],
      <span class="ruby-value">:vnetwork</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vmnet</span>,
      <span class="ruby-value">:vcenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vcenter_name</span>,
      <span class="ruby-value">:vdatacenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vdc1</span>,
      <span class="ruby-value">:usedstorage</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.storage.committed&#39;</span>],
      <span class="ruby-value">:provisionedstorage</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">provisionedstorage</span>,
      <span class="ruby-value">:unsharedstorage</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.storage.unshared&#39;</span>],
      )
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Ohm</span><span class="ruby-operator">::</span><span class="ruby-constant">UniqueIndexViolation</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">fault</span>
      <span class="ruby-identifier">vm1_id</span> = <span class="ruby-constant">Vm</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">locationid</span><span class="ruby-operator">:</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.config.locationId&#39;</span>]).<span class="ruby-identifier">to_a</span>[<span class="ruby-value">0</span>]
      <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;#{fault} - #{vm[&#39;name&#39;].downcase} already exists with id: #{vm1_id.id} - #{vm1_id.name}&quot;</span>
      <span class="ruby-keyword">next</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># add attached datastores to the list within Vdatastore object</span>
    <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">ds_names</span> = []
    <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;datastore&#39;</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">vm_ds</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">ds_names</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">datastores</span>.<span class="ruby-identifier">values_at</span>(<span class="ruby-identifier">vm_ds</span>)[<span class="ruby-value">0</span>][<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">downcase</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">ds_names</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">vmds_id</span> = <span class="ruby-constant">Vdatastore</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">d</span>).<span class="ruby-identifier">to_a</span>[<span class="ruby-value">0</span>]
      <span class="ruby-identifier">vm1</span>.<span class="ruby-identifier">vdatastores</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">vmds_id</span>)
      <span class="ruby-identifier">vmds_id</span>.<span class="ruby-identifier">vms</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">vm1</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">fault</span>
      <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;#{fault} - #{vm[&#39;name&#39;].downcase} datastore_id not present&quot;</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">end</span>



<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-cluster_output" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">cluster_output</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="cluster_output-source">
            <pre><span class="ruby-comment"># File lib/vc_collect.rb, line 287</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">cluster_output</span>
  <span class="ruby-identifier">output</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">key</span>] = [] }
  <span class="ruby-identifier">output</span>[<span class="ruby-string">&#39;timestamp&#39;</span>] = <span class="ruby-ivar">@timestamp</span>
  <span class="ruby-ivar">@clusters</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cluster</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">output</span>[<span class="ruby-identifier">cluster</span>[<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">downcase</span>] = {
      <span class="ruby-value">:overallstatus</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cluster</span>[<span class="ruby-string">&#39;overallStatus&#39;</span>],
      <span class="ruby-value">:effectivecpu</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cluster</span>[<span class="ruby-string">&#39;summary.effectiveCpu&#39;</span>],
      <span class="ruby-value">:effectivememory</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cluster</span>[<span class="ruby-string">&#39;summary.effectiveMemory&#39;</span>],
      <span class="ruby-value">:numeffectivehosts</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cluster</span>[<span class="ruby-string">&#39;summary.numEffectiveHosts&#39;</span>],
      <span class="ruby-value">:numhosts</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cluster</span>[<span class="ruby-string">&#39;summary.numHosts&#39;</span>],
      <span class="ruby-value">:totalcpu</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cluster</span>[<span class="ruby-string">&#39;summary.totalCpu&#39;</span>],
      <span class="ruby-value">:totalmemory</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cluster</span>[<span class="ruby-string">&#39;summary.totalMemory&#39;</span>],
      <span class="ruby-value">:vcenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vc1</span>,
      <span class="ruby-value">:vdatacenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vdc1</span>
      }
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@vc_results_output</span>, <span class="ruby-node">&quot;#{@vc1}_Cluster.json&quot;</span>), <span class="ruby-string">&quot;w&quot;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">f</span>.<span class="ruby-identifier">write</span>(<span class="ruby-constant">JSON</span>.<span class="ruby-identifier">pretty_generate</span>(<span class="ruby-identifier">output</span>))
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-datastore_output" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">datastore_output</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="datastore_output-source">
            <pre><span class="ruby-comment"># File lib/vc_collect.rb, line 265</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">datastore_output</span>
  <span class="ruby-identifier">output</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">key</span>] = [] }
  <span class="ruby-identifier">output</span>[<span class="ruby-string">&#39;timestamp&#39;</span>] = <span class="ruby-ivar">@timestamp</span>
  <span class="ruby-ivar">@datastores</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">output</span>[<span class="ruby-identifier">ds</span>[<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">downcase</span>] = {
      <span class="ruby-value">:capacity</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ds</span>[<span class="ruby-string">&#39;summary.capacity&#39;</span>],
      <span class="ruby-value">:free</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ds</span>[<span class="ruby-string">&#39;summary.freeSpace&#39;</span>],
      <span class="ruby-value">:used</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-identifier">ds</span>[<span class="ruby-string">&#39;summary.capacity&#39;</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">ds</span>[<span class="ruby-string">&#39;summary.freeSpace&#39;</span>]),
      <span class="ruby-comment">#:pct_used =&gt; (ds[&#39;summary.capacity&#39;].to_i - ds[&#39;summary.freeSpace&#39;].to_i) * 100 / ds[&#39;summary.capacity&#39;].to_i,</span>
      <span class="ruby-value">:url</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ds</span>[<span class="ruby-string">&#39;summary.url&#39;</span>],
      <span class="ruby-value">:accessible</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ds</span>[<span class="ruby-string">&#39;summary.accessible&#39;</span>],
      <span class="ruby-value">:vcenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vc1</span>,
      <span class="ruby-value">:vdatacenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vdc1</span>
    }
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@vc_results_output</span>, <span class="ruby-node">&quot;#{@vc1}_Vdatastore.json&quot;</span>), <span class="ruby-string">&quot;w&quot;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">f</span>.<span class="ruby-identifier">write</span>(<span class="ruby-constant">JSON</span>.<span class="ruby-identifier">pretty_generate</span>(<span class="ruby-identifier">output</span>))
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-dvs_output" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">dvs_output</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="dvs_output-source">
            <pre><span class="ruby-comment"># File lib/vc_collect.rb, line 248</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">dvs_output</span>
  <span class="ruby-identifier">output</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">key</span>] = [] }
  <span class="ruby-identifier">output</span>[<span class="ruby-string">&#39;timestamp&#39;</span>] = <span class="ruby-ivar">@timestamp</span>
  <span class="ruby-ivar">@dvs</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">vss</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">output</span>[<span class="ruby-identifier">vss</span>[<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">downcase</span>] = { 
      <span class="ruby-value">:uuid</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vss</span>[<span class="ruby-string">&#39;uuid&#39;</span>],
      <span class="ruby-value">:portgroups</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vss</span>[<span class="ruby-string">&#39;summary&#39;</span>][<span class="ruby-value">:portgroupName</span>],
      <span class="ruby-value">:vcenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vc1</span>,
      <span class="ruby-value">:vdatacenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vdc1</span>
    }
  <span class="ruby-keyword">end</span>
  <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@vc_results_output</span>, <span class="ruby-node">&quot;#{@vc1}_Vnetwork.json&quot;</span>), <span class="ruby-string">&quot;w&quot;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">f</span>.<span class="ruby-identifier">write</span>(<span class="ruby-constant">JSON</span>.<span class="ruby-identifier">pretty_generate</span>(<span class="ruby-identifier">output</span>))
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-get_vcenter_data" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_vcenter_data</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>vcenter api call method</p>
          
          

          
          <div class="method-source-code" id="get_vcenter_data-source">
            <pre><span class="ruby-comment"># File lib/vc_collect.rb, line 75</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_vcenter_data</span>
  <span class="ruby-comment"># properties to pull from managed data objects</span>
  <span class="ruby-identifier">cluster_props</span> = [ <span class="ruby-string">&#39;name&#39;</span>, <span class="ruby-string">&#39;overallStatus&#39;</span>, <span class="ruby-string">&#39;summary.effectiveCpu&#39;</span>, <span class="ruby-string">&#39;summary.effectiveMemory&#39;</span>, <span class="ruby-string">&#39;summary.numEffectiveHosts&#39;</span>, <span class="ruby-string">&#39;summary.numHosts&#39;</span>,
    <span class="ruby-string">&#39;summary.totalCpu&#39;</span>, <span class="ruby-string">&#39;summary.totalMemory&#39;</span>, <span class="ruby-string">&#39;host&#39;</span> ]

  <span class="ruby-identifier">ds_props</span> = [ <span class="ruby-string">&#39;name&#39;</span>, <span class="ruby-string">&#39;summary.freeSpace&#39;</span>, <span class="ruby-string">&#39;summary.capacity&#39;</span>, <span class="ruby-string">&#39;summary.accessible&#39;</span>, <span class="ruby-string">&#39;summary.url&#39;</span>, <span class="ruby-string">&#39;host&#39;</span>, <span class="ruby-string">&#39;vm&#39;</span> ]

  <span class="ruby-identifier">host_props</span> = [ <span class="ruby-string">&#39;name&#39;</span>, <span class="ruby-string">&#39;parent&#39;</span>, <span class="ruby-string">&#39;overallStatus&#39;</span>, <span class="ruby-string">&#39;summary.quickStats.overallCpuUsage&#39;</span>, 
    <span class="ruby-string">&#39;summary.quickStats.overallMemoryUsage&#39;</span>, <span class="ruby-string">&#39;runtime.connectionState&#39;</span>, 
    <span class="ruby-string">&#39;runtime.powerState&#39;</span>, <span class="ruby-string">&#39;runtime.healthSystemRuntime&#39;</span>,<span class="ruby-string">&#39;config.network&#39;</span>, <span class="ruby-string">&#39;config.service&#39;</span>,
    <span class="ruby-string">&#39;datastore&#39;</span>, <span class="ruby-string">&#39;config.fileSystemVolume&#39;</span>, <span class="ruby-string">&#39;summary.hardware.memorySize&#39;</span>,
    <span class="ruby-string">&#39;summary.runtime.inMaintenanceMode&#39;</span>, <span class="ruby-string">&#39;hardware.biosInfo&#39;</span>, <span class="ruby-string">&#39;summary.quickStats.uptime&#39;</span>,
    <span class="ruby-string">&#39;summary.hardware.model&#39;</span> ]

  <span class="ruby-identifier">vm_props</span> = [ <span class="ruby-string">&#39;name&#39;</span>, <span class="ruby-string">&#39;guest.ipAddress&#39;</span>, <span class="ruby-string">&#39;guest.net&#39;</span>, <span class="ruby-string">&#39;guest.disk&#39;</span>, <span class="ruby-string">&#39;summary.overallStatus&#39;</span>,
    <span class="ruby-string">&#39;summary.config.vmPathName&#39;</span>, <span class="ruby-string">&#39;config.locationId&#39;</span>, <span class="ruby-string">&#39;summary.config.memorySizeMB&#39;</span>, <span class="ruby-string">&#39;summary.config.numCpu&#39;</span>,
    <span class="ruby-string">&#39;summary.config.template&#39;</span>, <span class="ruby-string">&#39;summary.guest.guestFullName&#39;</span>, <span class="ruby-string">&#39;datastore&#39;</span>, <span class="ruby-string">&#39;network&#39;</span>, <span class="ruby-string">&#39;summary.runtime.host&#39;</span>,
    <span class="ruby-string">&#39;summary.runtime.powerState&#39;</span>, <span class="ruby-string">&#39;storage.perDatastoreUsage&#39;</span>, <span class="ruby-string">&#39;summary.storage.committed&#39;</span>, <span class="ruby-string">&#39;summary.storage.uncommitted&#39;</span>,
    <span class="ruby-string">&#39;summary.storage.unshared&#39;</span>, <span class="ruby-string">&#39;summary.guest.toolsVersionStatus2&#39;</span>,<span class="ruby-string">&#39;summary.guest.toolsRunningStatus&#39;</span>,
    <span class="ruby-string">&#39;summary.quickStats.hostMemoryUsage&#39;</span>,<span class="ruby-string">&#39;summary.quickStats.guestMemoryUsage&#39;</span>,<span class="ruby-string">&#39;summary.quickStats.balloonedMemory&#39;</span>,
    <span class="ruby-string">&#39;summary.quickStats.uptimeSeconds&#39;</span>, <span class="ruby-string">&#39;summary.guest.ipAddress&#39;</span> ]

    <span class="ruby-comment"># &#39;storage.timestamp&#39;, &#39;summary.quickStats&#39;, &#39;summary.runtime.device&#39;, &#39;summary.guest.hostName&#39;, &#39;summary.guest.ipAddress&#39;,</span>
    <span class="ruby-comment"># &#39;guest.net.macAddress&#39;, &#39;guest.net.network&#39;, &#39;layoutEx&#39;, &#39;summary.config.instanceUuid&#39;, &#39;config.datastoreUrl&#39;, &#39;summary.runtime.cleanPowerOff&#39;,</span>
    <span class="ruby-comment"># &#39;summary.runtime.consolidationNeeded&#39;,</span>

  <span class="ruby-identifier">propSet</span> = [{ <span class="ruby-value">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;VirtualMachine&#39;</span>, <span class="ruby-value">:pathSet</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm_props</span> }]

  <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;gathering info from #{@vc1} based on filterSpec&quot;</span>

  <span class="ruby-identifier">filterSpec</span> = <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span><span class="ruby-operator">::</span><span class="ruby-constant">PropertyFilterSpec</span>(
    <span class="ruby-value">:objectSet</span> =<span class="ruby-operator">&gt;</span> [
      <span class="ruby-value">:obj</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vim</span>.<span class="ruby-identifier">serviceInstance</span>.<span class="ruby-identifier">content</span>.<span class="ruby-identifier">rootFolder</span>, 
      <span class="ruby-value">:selectSet</span> =<span class="ruby-operator">&gt;</span> [
        
        <span class="ruby-comment"># traverse root folder</span>
        <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span>.<span class="ruby-constant">TraversalSpec</span>(
          <span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;tsFolder&#39;</span>,
          <span class="ruby-value">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;Folder&#39;</span>, 
          <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;childEntity&#39;</span>,
          <span class="ruby-value">:skip</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;false&#39;</span>,
          <span class="ruby-value">:selectSet</span> =<span class="ruby-operator">&gt;</span> [
            <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span>.<span class="ruby-constant">SelectionSpec</span>(<span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;tsFolder&#39;</span>),
            <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span>.<span class="ruby-constant">SelectionSpec</span>(<span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;tsDatacenterVmFolder&#39;</span>),
            <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span>.<span class="ruby-constant">SelectionSpec</span>(<span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;tsDatacenterHostFolder&#39;</span>),
            <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span>.<span class="ruby-constant">SelectionSpec</span>(<span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;tsDatacenterNetworkFolder&#39;</span>),
            <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span>.<span class="ruby-constant">SelectionSpec</span>(<span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;tsDatacenterdatastoreFolder&#39;</span>),
            <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span>.<span class="ruby-constant">SelectionSpec</span>(<span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;tsClusterHost&#39;</span>)
          ]
          ),
        
        <span class="ruby-comment"># traverse through vmfolder</span>
        <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span>.<span class="ruby-constant">TraversalSpec</span>(
          <span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;tsDatacenterVmFolder&#39;</span>,
          <span class="ruby-value">:type</span> =<span class="ruby-operator">&gt;</span><span class="ruby-string">&#39;Datacenter&#39;</span>,
          <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;vmFolder&#39;</span>,
          <span class="ruby-value">:skip</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;false&#39;</span>,
          <span class="ruby-value">:selectSet</span> =<span class="ruby-operator">&gt;</span> [
            <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span>.<span class="ruby-constant">SelectionSpec</span>(<span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;tsFolder&#39;</span>)
          ]
          ),

        <span class="ruby-comment"># traverse through hostFolder</span>
        <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span>.<span class="ruby-constant">TraversalSpec</span>(
          <span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;tsDatacenterHostFolder&#39;</span>,
          <span class="ruby-value">:type</span> =<span class="ruby-operator">&gt;</span><span class="ruby-string">&#39;Datacenter&#39;</span>,
          <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;hostFolder&#39;</span>,
          <span class="ruby-value">:skip</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;false&#39;</span>,
          <span class="ruby-value">:selectSet</span> =<span class="ruby-operator">&gt;</span> [
            <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span>.<span class="ruby-constant">SelectionSpec</span>(<span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;tsFolder&#39;</span>)
          ]
          ),

        <span class="ruby-comment"># traverse through dataStore folder</span>
        <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span>.<span class="ruby-constant">TraversalSpec</span>(
          <span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;tsDatacenterdatastoreFolder&#39;</span>,
          <span class="ruby-value">:type</span> =<span class="ruby-operator">&gt;</span><span class="ruby-string">&#39;Datacenter&#39;</span>,
          <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;datastoreFolder&#39;</span>,
          <span class="ruby-value">:skip</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;false&#39;</span>,
          <span class="ruby-value">:selectSet</span> =<span class="ruby-operator">&gt;</span> [
            <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span>.<span class="ruby-constant">SelectionSpec</span>(<span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;tsFolder&#39;</span>)
          ]
          ),

        <span class="ruby-comment"># traverse hosts by cluster</span>
        <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span>.<span class="ruby-constant">TraversalSpec</span>(
          <span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;tsClusterHost&#39;</span>,
          <span class="ruby-value">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;ComputeResource&#39;</span>,
          <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;host&#39;</span>,
          <span class="ruby-value">:skip</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;false&#39;</span>,
          <span class="ruby-value">:selectSet</span> =<span class="ruby-operator">&gt;</span> [
          ]
          ),

        <span class="ruby-comment"># traverse network folder</span>
        <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span>.<span class="ruby-constant">TraversalSpec</span>(
          <span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;tsDatacenterNetworkFolder&#39;</span>,
          <span class="ruby-value">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;Datacenter&#39;</span>,
          <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;networkFolder&#39;</span>,
          <span class="ruby-value">:skip</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;false&#39;</span>,
          <span class="ruby-value">:selectSet</span> =<span class="ruby-operator">&gt;</span> [
            <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span>.<span class="ruby-constant">SelectionSpec</span>(<span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;tsFolder&#39;</span>)
          ]
          ),

      ]

    ],
    <span class="ruby-comment"># declare properties we want to retrieve from each object type</span>
    <span class="ruby-value">:propSet</span> =<span class="ruby-operator">&gt;</span> [
      { <span class="ruby-value">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;VirtualMachine&#39;</span>, <span class="ruby-value">:pathSet</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm_props</span>, <span class="ruby-value">:all</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>  },
      { <span class="ruby-value">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;Datastore&#39;</span>, <span class="ruby-value">:pathSet</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ds_props</span> },
      { <span class="ruby-value">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;HostSystem&#39;</span>, <span class="ruby-value">:pathSet</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">host_props</span> },
      { <span class="ruby-value">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;ComputeResource&#39;</span>, <span class="ruby-value">:pathSet</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cluster_props</span> },
      <span class="ruby-comment"># { :type =&gt; &#39;Datacenter&#39;, :pathSet =&gt; [&#39;name&#39;] },</span>
      <span class="ruby-comment"># { :type =&gt; &#39;Folder&#39;, :pathSet =&gt; [&#39;name&#39;, &#39;parent&#39;] },</span>
      { <span class="ruby-value">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;DistributedVirtualSwitch&#39;</span>, <span class="ruby-value">:pathSet</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-string">&#39;name&#39;</span>, <span class="ruby-string">&#39;uuid&#39;</span>, <span class="ruby-string">&#39;summary&#39;</span>, <span class="ruby-string">&#39;runtime&#39;</span>] },
      { <span class="ruby-value">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;DistributedVirtualPortgroup&#39;</span>, <span class="ruby-value">:pathSet</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-string">&#39;name&#39;</span>, <span class="ruby-string">&#39;key&#39;</span>, <span class="ruby-string">&#39;summary&#39;</span>] }
    ]
  )


  <span class="ruby-ivar">@timestamp</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_i</span>

  <span class="ruby-identifier">results</span> = <span class="ruby-ivar">@vim</span>.<span class="ruby-identifier">propertyCollector</span>.<span class="ruby-constant">RetrieveProperties</span>(<span class="ruby-value">:specSet</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">filterSpec</span>])

  <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;results retrieved, sorting...&quot;</span>

  <span class="ruby-comment"># @vms = {}</span>
  <span class="ruby-comment"># @dvs = {}</span>
  <span class="ruby-comment"># @dvpg = {}</span>
  <span class="ruby-comment"># #network = {}</span>
  <span class="ruby-comment"># @hosts = {}</span>
  <span class="ruby-comment"># @clusters = {}</span>
  <span class="ruby-comment"># @datastores = {}</span>
  <span class="ruby-comment"># @datacenter = {}</span>
  <span class="ruby-comment"># @folders = {}</span>
 
  <span class="ruby-comment"># this will produce a hash with the obj being the key, and the properties being the value</span>
  <span class="ruby-comment"># todo: consider using case/when statement here</span>
  <span class="ruby-identifier">results</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span><span class="ruby-operator">::</span><span class="ruby-constant">VirtualMachine</span>)
      <span class="ruby-ivar">@vms</span>[<span class="ruby-identifier">data</span>.<span class="ruby-identifier">obj</span>] = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_hash</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span><span class="ruby-operator">::</span><span class="ruby-constant">DistributedVirtualSwitch</span>)
      <span class="ruby-ivar">@dvs</span>[<span class="ruby-identifier">data</span>.<span class="ruby-identifier">obj</span>] = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_hash</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span><span class="ruby-operator">::</span><span class="ruby-constant">DistributedVirtualPortgroup</span>)
      <span class="ruby-ivar">@dvpg</span>[<span class="ruby-identifier">data</span>.<span class="ruby-identifier">obj</span>] = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_hash</span>
    <span class="ruby-comment"># elsif data.obj.is_a?(RbVmomi::VIM::Network)</span>
    <span class="ruby-comment">#  @network[data.obj] = data.to_hash</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span><span class="ruby-operator">::</span><span class="ruby-constant">HostSystem</span>)
      <span class="ruby-ivar">@hosts</span>[<span class="ruby-identifier">data</span>.<span class="ruby-identifier">obj</span>] = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_hash</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span><span class="ruby-operator">::</span><span class="ruby-constant">ComputeResource</span>)
      <span class="ruby-ivar">@clusters</span>[<span class="ruby-identifier">data</span>.<span class="ruby-identifier">obj</span>] = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_hash</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span><span class="ruby-operator">::</span><span class="ruby-constant">Datastore</span>)
      <span class="ruby-ivar">@datastores</span>[<span class="ruby-identifier">data</span>.<span class="ruby-identifier">obj</span>] = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_hash</span>
    <span class="ruby-comment"># elsif data.obj.is_a?(RbVmomi::VIM::Datacenter)</span>
    <span class="ruby-comment">#  @datacenter[data.obj] = data.to_hash</span>
    <span class="ruby-comment"># elsif data.obj.is_a?(RbVmomi::VIM::Folder)</span>
    <span class="ruby-comment">#  @folders[data.obj] = data.to_hash     </span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># send sorted results to redis store method #build_tree</span>
  <span class="ruby-comment">#build_tree(@dvpg, @dvs, @datastores, @clusters, @hosts, @vms, @vcenter_name)</span>
  <span class="ruby-comment"># dvs_output</span>
  <span class="ruby-comment"># virt_machine_output</span>
  <span class="ruby-comment"># hostsystem_output</span>
  <span class="ruby-comment"># cluster_output</span>
  <span class="ruby-comment"># datastore_output</span>


<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-hostsystem_output" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">hostsystem_output</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="hostsystem_output-source">
            <pre><span class="ruby-comment"># File lib/vc_collect.rb, line 310</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">hostsystem_output</span>
  <span class="ruby-identifier">output</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">key</span>] = [] }
  <span class="ruby-identifier">output</span>[<span class="ruby-string">&#39;timestamp&#39;</span>] = <span class="ruby-ivar">@timestamp</span>
    <span class="ruby-ivar">@hosts</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cnode</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># get the cluster object associated with this host</span>
    <span class="ruby-comment">#cluster_name = clusters.values_at(cnode[&#39;parent&#39;])[0][&#39;name&#39;]</span>
    <span class="ruby-identifier">clusta</span> = <span class="ruby-ivar">@clusters</span>.<span class="ruby-identifier">values_at</span>(<span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;parent&#39;</span>])[<span class="ruby-value">0</span>][<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">downcase</span>

    <span class="ruby-comment"># create a new hash with the key being sensorType and the value an array of sensor values</span>
    <span class="ruby-identifier">host_sensor_values</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">key</span>] = [] }
    <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;runtime.healthSystemRuntime&#39;</span>][<span class="ruby-value">:systemHealthInfo</span>][<span class="ruby-value">:numericSensorInfo</span>].<span class="ruby-identifier">collect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">host_sensor_values</span>[<span class="ruby-identifier">x</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_sym</span>] = <span class="ruby-identifier">x</span>.<span class="ruby-identifier">healthState</span>.<span class="ruby-identifier">props</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> {<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">to_sym</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span>} <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/dynamicProperty/</span> }.<span class="ruby-identifier">compact</span>
      <span class="ruby-identifier">host_sensor_values</span>[<span class="ruby-identifier">x</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_sym</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">x</span>.<span class="ruby-identifier">props</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> {<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">to_sym</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span>} <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/currentReading|baseUnits|sensorType/</span> }.<span class="ruby-identifier">compact</span>
    <span class="ruby-keyword">end</span>
    
    <span class="ruby-comment"># host services. get name, runlevel option, current status (:running is boolean)</span>
    <span class="ruby-identifier">host_services</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">key</span>] = [] }

    <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;config.service&#39;</span>][<span class="ruby-value">:service</span>].<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> 
      <span class="ruby-identifier">host_services</span>[<span class="ruby-identifier">x</span>.<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">x</span>.<span class="ruby-identifier">props</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> {<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">to_sym</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span>} <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/label|policy|running/</span> }.<span class="ruby-identifier">compact</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">host_filesystems</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">key</span>] = [] }

    <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;config.fileSystemVolume&#39;</span>][<span class="ruby-value">:mountInfo</span>].<span class="ruby-identifier">collect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">host_filesystems</span>[<span class="ruby-identifier">x</span>.<span class="ruby-identifier">mountInfo</span>.<span class="ruby-identifier">path</span>] = <span class="ruby-identifier">x</span>.<span class="ruby-identifier">mountInfo</span>.<span class="ruby-identifier">props</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> {<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">to_sym</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span>} <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/dynamicProperty/</span> }.<span class="ruby-identifier">compact</span>
      <span class="ruby-identifier">host_filesystems</span>[<span class="ruby-identifier">x</span>.<span class="ruby-identifier">mountInfo</span>.<span class="ruby-identifier">path</span>] = <span class="ruby-identifier">x</span>.<span class="ruby-identifier">volume</span>.<span class="ruby-identifier">props</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> {<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">to_sym</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span>} <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/dynamicProperty|extent/</span> }.<span class="ruby-identifier">compact</span>
    <span class="ruby-keyword">end</span>
    
    <span class="ruby-identifier">route_info</span> = {}
    <span class="ruby-identifier">route_info</span> = <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;config.network&#39;</span>][<span class="ruby-value">:dnsConfig</span>].<span class="ruby-identifier">props</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
      {<span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>] =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>]} <span class="ruby-keyword">if</span> <span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/domainName|address|searchDomain/</span>
    <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>

    <span class="ruby-identifier">biosinfo</span> = {}
    <span class="ruby-identifier">biosInfo</span> = <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;hardware.biosInfo&#39;</span>].<span class="ruby-identifier">props</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span>
      {<span class="ruby-identifier">b</span>[<span class="ruby-value">0</span>] =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">b</span>[<span class="ruby-value">1</span>]} <span class="ruby-keyword">unless</span> <span class="ruby-identifier">b</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/dynamicProperty/</span>
    <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>
    
    <span class="ruby-identifier">vnic_output</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">key</span>] = [] }
    <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;config.network&#39;</span>][<span class="ruby-value">:vnic</span>].<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">vnic</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">vnic_output</span>[<span class="ruby-identifier">vnic</span>.<span class="ruby-identifier">device</span>.<span class="ruby-identifier">to_sym</span>] = { 
        <span class="ruby-value">:portkey</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vnic</span>.<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">distributedVirtualPort</span>.<span class="ruby-identifier">portKey</span>, 
        <span class="ruby-value">:portgroupkey</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vnic</span>.<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">distributedVirtualPort</span>.<span class="ruby-identifier">portgroupKey</span>, 
        <span class="ruby-value">:switchuuid</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vnic</span>.<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">distributedVirtualPort</span>.<span class="ruby-identifier">switchUuid</span>, 
        <span class="ruby-value">:ipaddress</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vnic</span>.<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">ip</span>.<span class="ruby-identifier">ipAddress</span>, 
        <span class="ruby-value">:subnet</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vnic</span>.<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">ip</span>.<span class="ruby-identifier">subnetMask</span>, 
        <span class="ruby-value">:mtu</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vnic</span>.<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">mtu</span>
      }
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">fault</span>
      <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;#{fault} - #{cnode[&#39;name&#39;]} be havin a problem with vnics&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">h1_name</span> = <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">partition</span>(<span class="ruby-string">&#39;.&#39;</span>).<span class="ruby-identifier">shift</span>.<span class="ruby-identifier">downcase</span>
    <span class="ruby-identifier">h1_domain</span> = <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">partition</span>(<span class="ruby-string">&#39;.&#39;</span>).<span class="ruby-identifier">pop</span>.<span class="ruby-identifier">downcase</span>
    <span class="ruby-comment"># create new host entry in redis</span>

    <span class="ruby-identifier">output</span>[<span class="ruby-identifier">h1_name</span>] = {
      <span class="ruby-value">:domain</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">h1_domain</span>,
      <span class="ruby-value">:overallstatus</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;overallStatus&#39;</span>],
      <span class="ruby-value">:overallcpuusage</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;summary.quickStats.overallCpuUsage&#39;</span>],
      <span class="ruby-value">:overallmemoryusage</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;summary.quickStats.overallMemoryUsage&#39;</span>],
      <span class="ruby-value">:totalmemory</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;summary.hardware.memorySize&#39;</span>],
      <span class="ruby-value">:powerstate</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;runtime.powerState&#39;</span>],
      <span class="ruby-value">:connectionstate</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;runtime.connectionState&#39;</span>],
      <span class="ruby-value">:uptime</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;summary.quickStats.uptime&#39;</span>],
      <span class="ruby-value">:inmaintenancemode</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;summary.runtime.inMaintenanceMode&#39;</span>],
      <span class="ruby-value">:hardwaremodel</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cnode</span>[<span class="ruby-string">&#39;summary.hardware.model&#39;</span>],
      <span class="ruby-value">:vnics</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vnic_output</span>,
      <span class="ruby-value">:biosinfo</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">biosinfo</span>,
      <span class="ruby-value">:cluster</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">clusta</span>,
      <span class="ruby-value">:vcenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vc1</span>,
      <span class="ruby-value">:vdatacenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vdc1</span>,
      <span class="ruby-value">:filesystems</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">host_filesystems</span>,
      <span class="ruby-value">:services</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">host_services</span>, 
      <span class="ruby-value">:sensors</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">host_sensor_values</span>,
      <span class="ruby-value">:route_info</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">route_info</span>
    }

  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@vc_results_output</span>, <span class="ruby-node">&quot;#{@vc1}_Host.json&quot;</span>), <span class="ruby-string">&quot;w&quot;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">f</span>.<span class="ruby-identifier">write</span>(<span class="ruby-constant">JSON</span>.<span class="ruby-identifier">pretty_generate</span>(<span class="ruby-identifier">output</span>))
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-output" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">output</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="output-source">
            <pre><span class="ruby-comment"># File lib/vc_collect.rb, line 465</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">output</span>
  <span class="ruby-identifier">dvs_output</span>
  <span class="ruby-identifier">virt_machine_output</span>
  <span class="ruby-identifier">hostsystem_output</span>
  <span class="ruby-identifier">cluster_output</span>
  <span class="ruby-identifier">datastore_output</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-to_vcenter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">to_vcenter</span><span
            class="method-args">(vdc,vc,vc_user,vc_password)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>connect to the proper vcenter can be cmd line arg e.g. get datastore info
from isce1</p>
          
          

          
          <div class="method-source-code" id="to_vcenter-source">
            <pre><span class="ruby-comment"># File lib/vc_collect.rb, line 29</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">to_vcenter</span>(<span class="ruby-identifier">vdc</span>,<span class="ruby-identifier">vc</span>,<span class="ruby-identifier">vc_user</span>,<span class="ruby-identifier">vc_password</span>)
    <span class="ruby-ivar">@vdc1</span> = <span class="ruby-identifier">vdc</span>
    <span class="ruby-ivar">@vc1</span> = <span class="ruby-identifier">vc</span>.<span class="ruby-identifier">partition</span>(<span class="ruby-string">&#39;.&#39;</span>).<span class="ruby-identifier">shift</span>.<span class="ruby-identifier">downcase</span>
    <span class="ruby-ivar">@vc_results_output</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">@@json_results_dir</span>, <span class="ruby-ivar">@vc1</span>)
    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir</span>(<span class="ruby-ivar">@vc_results_output</span>) <span class="ruby-keyword">unless</span> <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-ivar">@vc_results_output</span>)
    <span class="ruby-comment"># create tunnel to vcenter server through the established gateway</span>
    <span class="ruby-keyword">begin</span>
    <span class="ruby-constant">GatewayJump</span><span class="ruby-operator">::</span><span class="ruby-identifier">tunnel</span>(<span class="ruby-string">&#39;vcenter&#39;</span>, <span class="ruby-identifier">vc</span>)
    <span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">fault</span>
      <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;#{fault} - unable to connect to vcenter #{vc}&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">begin</span>
      <span class="ruby-ivar">@vim</span> = <span class="ruby-constant">RbVmomi</span><span class="ruby-operator">::</span><span class="ruby-constant">VIM</span>.<span class="ruby-identifier">connect</span> <span class="ruby-value">:host</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;127.0.0.1&#39;</span>, 
      <span class="ruby-value">:port</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">2222</span>, 
      <span class="ruby-value">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vc_user</span>, 
      <span class="ruby-value">:password</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vc_password</span>, 
      <span class="ruby-value">:insecure</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">exc</span>
      <span class="ruby-identifier">p</span> <span class="ruby-identifier">exc</span>
      <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span>(<span class="ruby-identifier">exc</span>)
      <span class="ruby-identifier">exit</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">begin</span>
      <span class="ruby-comment">#@root_folder = @vim.serviceInstance.content.rootFolder</span>
      <span class="ruby-ivar">@dc</span> = <span class="ruby-ivar">@vim</span>.<span class="ruby-identifier">serviceInstance</span>.<span class="ruby-identifier">find_datacenter</span>
    <span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">exc</span>
      <span class="ruby-identifier">p</span> <span class="ruby-identifier">exc</span>
      <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span>(<span class="ruby-identifier">exc</span>)
      <span class="ruby-identifier">exit</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment">#@pc = @vim.serviceContent.propertyCollector</span>
    <span class="ruby-comment"># start collection of data - vcenter_name is the short name</span>
    <span class="ruby-comment"># vcenter_name = vc.partition(&#39;.&#39;).shift.downcase</span>
    <span class="ruby-comment">#get_vcenter_data</span>
    <span class="ruby-comment">#GatewayJump::close_tunnel</span>

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-virt_machine_output" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">virt_machine_output</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="virt_machine_output-source">
            <pre><span class="ruby-comment"># File lib/vc_collect.rb, line 397</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">virt_machine_output</span>
  <span class="ruby-identifier">output</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">key</span>] = [] }
  <span class="ruby-identifier">output</span>[<span class="ruby-string">&#39;timestamp&#39;</span>] = <span class="ruby-ivar">@timestamp</span>
  <span class="ruby-ivar">@vms</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">vm</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">begin</span>
    <span class="ruby-comment"># if vm is a template, create a new object in redis, noting it is a template. then go to the next vm data object</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.config.template&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
      <span class="ruby-identifier">output</span>[<span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">downcase</span>] = { <span class="ruby-identifier">vdatacenter</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@vdc1</span>, <span class="ruby-identifier">template</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;true&#39;</span> }
      <span class="ruby-keyword">next</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># get the host and cluster the vm belongs to</span>
    <span class="ruby-identifier">esx_host_fqdn</span> = <span class="ruby-ivar">@hosts</span>.<span class="ruby-identifier">values_at</span>(<span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.runtime.host&#39;</span>])[<span class="ruby-value">0</span>][<span class="ruby-string">&#39;name&#39;</span>]
    <span class="ruby-identifier">esx_host_name</span> = <span class="ruby-identifier">esx_host_fqdn</span>.<span class="ruby-identifier">partition</span>(<span class="ruby-string">&#39;.&#39;</span>)[<span class="ruby-value">0</span>].<span class="ruby-identifier">downcase</span>
    
    <span class="ruby-identifier">vmhost</span> = <span class="ruby-identifier">esx_host_name</span>
    <span class="ruby-comment">#vmcluster = Cluster[vmhost.cluster_id.to_i]</span>

    <span class="ruby-comment"># get the portgroup the vm is in. portgroup is an indexed attribute of a Vnetwork(vswitch) object bucket</span>
    <span class="ruby-identifier">portgroup</span> = <span class="ruby-ivar">@dvpg</span>.<span class="ruby-identifier">values_at</span>(<span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;network&#39;</span>][<span class="ruby-value">0</span>])[<span class="ruby-value">0</span>][<span class="ruby-string">&#39;name&#39;</span>]
    <span class="ruby-comment">#vmnet = Vnetwork.find(portgroup: portgroup).to_a[0]</span>
    
    <span class="ruby-comment"># calculate the total provisioned storage for the vm</span>
    <span class="ruby-comment"># unless vm[&#39;summary.storage.uncommitted&#39;].nil? || vm[&#39;summary.storage.committed&#39;].nil?</span>
    <span class="ruby-comment">#  provisionedstorage = vm[&#39;summary.storage.uncommitted&#39;] + vm[&#39;summary.storage.committed&#39;]</span>
    <span class="ruby-comment"># end</span>

    <span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">exc</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">portgroup</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;#{exc} - #{vm[&#39;name&#39;].downcase} is not assigned to a portgroup&quot;</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;#{exc} - #{vm[&#39;name&#39;].downcase} is f-ed up. check it&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">guestdisk</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">key</span>] = [] }
    <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;guest.disk&#39;</span>].<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">disk</span><span class="ruby-operator">|</span> <span class="ruby-identifier">disk</span>.<span class="ruby-identifier">props</span>}.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">disk_props</span><span class="ruby-operator">|</span> <span class="ruby-identifier">guestdisk</span>[<span class="ruby-identifier">disk_props</span>[<span class="ruby-value">:diskPath</span>].<span class="ruby-identifier">to_sym</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">disk_props</span>[<span class="ruby-value">:freeSpace</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">disk_props</span>[<span class="ruby-value">:capacity</span>] }
    
    <span class="ruby-comment"># create a new vm entry in redis</span>
    <span class="ruby-identifier">output</span>[<span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">downcase</span>] = {
      <span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;name&#39;</span>].<span class="ruby-identifier">downcase</span>,
      <span class="ruby-value">:overallstatus</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.overallStatus&#39;</span>],
      <span class="ruby-value">:numcpu</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.config.numCpu&#39;</span>],
      <span class="ruby-value">:memoryallocated</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.config.memorySizeMB&#39;</span>],
      <span class="ruby-value">:hostmemoryusage</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.quickStats.hostMemoryUsage&#39;</span>],
      <span class="ruby-value">:guestmemoryusage</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.quickStats.guestMemoryUsage&#39;</span>],
      <span class="ruby-value">:balloonedmemory</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.quickStats.balloonedMemory&#39;</span>],
      <span class="ruby-value">:ipaddr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.guest.ipAddress&#39;</span>],
      <span class="ruby-value">:os</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.guest.guestFullName&#39;</span>],
      <span class="ruby-value">:vmwaretools_status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.guest.toolsRunningStatus&#39;</span>],
      <span class="ruby-value">:vmwaretools_version</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.guest.toolsVersionStatus2&#39;</span>],
      <span class="ruby-value">:powerstate</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.runtime.powerState&#39;</span>],
      <span class="ruby-value">:uptime</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.quickStats.uptimeSeconds&#39;</span>],
      <span class="ruby-value">:guestdisk</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">guestdisk</span>,
      <span class="ruby-value">:host</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vmhost</span>,
      <span class="ruby-value">:locationid</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;config.locationId&#39;</span>],
      <span class="ruby-value">:portgroup</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">portgroup</span>,
      <span class="ruby-value">:vcenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vc1</span>,
      <span class="ruby-value">:vdatacenter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vdc1</span>,
      <span class="ruby-value">:usedstorage</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.storage.committed&#39;</span>],
      <span class="ruby-value">:unsharedstorage</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vm</span>[<span class="ruby-string">&#39;summary.storage.unshared&#39;</span>],
    }
  <span class="ruby-keyword">end</span>
  <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@vc_results_output</span>, <span class="ruby-node">&quot;#{@vc1}_Vm.json&quot;</span>), <span class="ruby-string">&quot;w&quot;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">f</span>.<span class="ruby-identifier">write</span>(<span class="ruby-constant">JSON</span>.<span class="ruby-identifier">pretty_generate</span>(<span class="ruby-identifier">output</span>))
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://rdoc.github.io/rdoc">RDoc</a> 5.0.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

